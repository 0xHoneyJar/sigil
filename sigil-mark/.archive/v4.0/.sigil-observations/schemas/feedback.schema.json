{
  "$schema": "http://json-schema.org/draft-07/schema#",
  "$id": "https://sigil.dev/schemas/feedback.schema.json",
  "title": "Sigil Observation Feedback Schema v4.0",
  "description": "Schema for feedback files generated by /observe. Captures structural analysis, measurable property comparisons, and human feedback.",
  "type": "object",
  "required": ["observation_id", "timestamp"],
  "properties": {
    "observation_id": {
      "type": "string",
      "description": "Unique identifier for this observation (e.g., 'obs-2026-01-07-001')"
    },
    "timestamp": {
      "type": "string",
      "description": "ISO timestamp when observation was captured",
      "format": "date-time"
    },
    "component": {
      "type": "string",
      "description": "Component or page being observed"
    },
    "zone": {
      "type": "string",
      "description": "Zone context for this observation"
    },
    "screenshot": {
      "type": "string",
      "description": "Relative path to screenshot file"
    },
    "url": {
      "type": "string",
      "description": "URL where observation was captured"
    },
    "structural": {
      "type": "array",
      "description": "Structural checks performed by agent",
      "items": {
        "$ref": "#/definitions/StructuralCheck"
      }
    },
    "measurable": {
      "type": "array",
      "description": "Measurable property comparisons",
      "items": {
        "$ref": "#/definitions/MeasurableProperty"
      }
    },
    "feedback": {
      "type": "array",
      "description": "Human feedback responses",
      "items": {
        "$ref": "#/definitions/FeedbackItem"
      }
    },
    "notes": {
      "type": "string",
      "description": "Additional notes from human review"
    },
    "applied": {
      "type": "boolean",
      "description": "Whether this feedback has been applied via /refine",
      "default": false
    },
    "applied_at": {
      "type": "string",
      "description": "ISO timestamp when feedback was applied",
      "format": "date-time"
    }
  },
  "definitions": {
    "StructuralCheck": {
      "type": "object",
      "required": ["check", "pass"],
      "properties": {
        "check": {
          "type": "string",
          "description": "What was checked (e.g., 'CriticalZone wrapper present')"
        },
        "expected": {
          "type": "boolean",
          "description": "Expected value"
        },
        "actual": {
          "type": "boolean",
          "description": "Actual value found"
        },
        "pass": {
          "type": "boolean",
          "description": "Whether check passed"
        },
        "details": {
          "type": "string",
          "description": "Additional details about the check"
        }
      }
    },
    "MeasurableProperty": {
      "type": "object",
      "required": ["property"],
      "properties": {
        "property": {
          "type": "string",
          "description": "CSS property or design token name (e.g., 'border-radius', 'animation-duration')"
        },
        "expected": {
          "type": "string",
          "description": "Expected value from rules.md"
        },
        "actual": {
          "type": "string",
          "description": "Actual value observed"
        },
        "delta": {
          "type": "boolean",
          "description": "Whether there is a mismatch",
          "default": false
        },
        "source": {
          "type": "string",
          "description": "Source of expected value (e.g., 'rules.md:45')"
        },
        "severity": {
          "type": "string",
          "description": "How important this mismatch is",
          "enum": ["info", "warning", "error"]
        }
      }
    },
    "FeedbackItem": {
      "type": "object",
      "required": ["question_id", "question"],
      "properties": {
        "question_id": {
          "type": "string",
          "description": "Unique identifier for this question"
        },
        "question": {
          "type": "string",
          "description": "The question asked to the human"
        },
        "options": {
          "type": "array",
          "description": "Available answer options",
          "items": {
            "type": "string"
          }
        },
        "answer": {
          "type": "string",
          "description": "Human's answer",
          "enum": ["yes_update_rules", "no_fix_component", "skip", "other"]
        },
        "answer_text": {
          "type": "string",
          "description": "Free-form answer text if 'other' was selected"
        },
        "comment": {
          "type": "string",
          "description": "Additional comment from human"
        },
        "property": {
          "type": "string",
          "description": "Property this feedback relates to"
        },
        "value": {
          "type": "string",
          "description": "Value to use if updating rules"
        }
      }
    }
  }
}
