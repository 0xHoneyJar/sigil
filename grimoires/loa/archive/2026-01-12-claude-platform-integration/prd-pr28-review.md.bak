# Product Requirements Document: PR #28 Review

## Executive Summary

**Objective**: Review PR #28 (consolidated research improvements and Anthropic oracle) to identify improvements before merging.

**Context**: This PR was implemented by Claude without formal Loa workflow review. It consolidates learnings from:
- PR #26: Continuous-Claude-v3 patterns (pre-mortem risk analysis, session hooks)
- PR #27: Kiro analysis (EARS notation, hooks documentation)

**Scope**: Quality review focusing on completeness, correctness, consistency with Loa patterns, and potential gaps.

---

## 1. Problem Statement

PR #28 implements several new features in a single commit without going through Loa's standard review workflow (`/review-sprint`, `/audit-sprint`). While the features appear valuable, they may have:
- Inconsistencies with existing Loa patterns
- Missing integrations with existing systems
- Documentation gaps
- Untested edge cases
- Opportunities for enhancement

---

## 2. Files Under Review

| File | Purpose | Lines Added |
|------|---------|-------------|
| `.claude/protocols/risk-analysis.md` | Pre-mortem risk framework | 286 |
| `.claude/protocols/recommended-hooks.md` | Claude Code hooks docs | 313 |
| `.claude/skills/discovering-requirements/resources/templates/ears-requirements.md` | EARS notation templates | 150 |
| `.claude/scripts/anthropic-oracle.sh` | Update monitoring script | 411 |
| `.claude/commands/oracle-analyze.md` | Analysis command | 108 |
| `.github/workflows/oracle.yml` | Automated workflow | 143 |

**Total**: 1,411 lines across 6 files

---

## 3. Review Criteria

### 3.1 EARS Requirements Template

**Source**: Kiro research (PR #27)

**Review Questions**:
- [ ] Are all 6 EARS patterns correctly documented?
- [ ] Is the PRD section template consistent with Loa's PRD format?
- [ ] Is the template discoverable by the `discovering-requirements` skill?
- [ ] Should EARS be optional or default for PRDs?

**Integration Check**:
- [ ] Does the skill's `SKILL.md` reference this template?
- [ ] Is this mentioned in the skill's `index.yaml`?

---

### 3.2 Recommended Hooks Protocol

**Source**: Both research PRs

**Review Questions**:
- [ ] Are the hook examples valid Claude Code syntax?
- [ ] Do the referenced scripts exist (e.g., `session-end-checkpoint.sh`)?
- [ ] Is the `CLAUDE_TOOL_INPUT` environment variable correct?
- [ ] Are the matcher patterns tested and accurate?

**Integration Check**:
- [ ] Should there be a `/setup-hooks` command?
- [ ] Should CLAUDE.md reference this protocol?
- [ ] Are any hooks immediately actionable?

---

### 3.3 Risk Analysis Protocol

**Source**: Continuous-Claude-v3 (PR #26)

**Review Questions**:
- [ ] Is the Tiger/Paper Tiger/Elephant framework clearly explained?
- [ ] Does the two-pass verification work in practice?
- [ ] Are the pattern examples in the "Automation" section valid regex?

**Integration Check**:
- [ ] Should `/architect` run pre-mortem analysis?
- [ ] Should `/audit-sprint` use this categorization?
- [ ] Should there be a `/risk-analysis` command?

---

### 3.4 Anthropic Oracle Script

**Technical Review**:
- [ ] Does `declare -A` (associative array) work on macOS default bash (3.2)?
- [ ] Is `jq` dependency documented?
- [ ] Does the `stat` command work cross-platform (Linux `-c %Y` vs macOS `-f %m`)?
- [ ] Are error messages user-friendly?

**Functional Review**:
- [ ] Does `check` command work end-to-end?
- [ ] Does `sources` command display correctly?
- [ ] Does `history` command parse JSONL correctly?
- [ ] Does `template` output correct placeholders?

**Gap Analysis**:
- [ ] Should there be a `diff` command to compare fetches?
- [ ] Should there be content hashing to detect changes?
- [ ] Should RSS/Atom feeds be added for blog?

---

### 3.5 Oracle Analyze Command

**Review Questions**:
- [ ] Are the analysis instructions actionable for Claude?
- [ ] Is the output path correct (`grimoires/pub/research/`)?
- [ ] Is the template command correct?
- [ ] Does the workflow section match the GitHub Action?

**Gap Analysis**:
- [ ] Should the command auto-run the script if cache is stale?
- [ ] Should there be a "last analysis" tracking mechanism?
- [ ] Should findings link to specific Loa files for updates?

---

### 3.6 GitHub Actions Workflow

**Technical Review**:
- [ ] Is the workflow syntax valid?
- [ ] Are the permissions minimal (contents: read, issues: write)?
- [ ] Is artifact retention (7 days) appropriate?
- [ ] Does the issue template render correctly?

**Operational Review**:
- [ ] Will weekly schedule create too many issues?
- [ ] Should issues auto-close after analysis?
- [ ] Should there be duplicate detection?

**Gap Analysis**:
- [ ] Should there be a "no changes detected" path?
- [ ] Should the workflow compare to previous fetch?
- [ ] Should notifications go to Discord/Slack?

---

## 4. Identified Gaps (Pre-Review)

Based on initial analysis, potential gaps include:

### 4.1 Missing Scripts

The `recommended-hooks.md` references scripts that don't exist:
- `.claude/scripts/session-end-checkpoint.sh`
- `.claude/scripts/auto-test.sh`
- `.claude/scripts/extract-session-state.sh`

**Recommendation**: Either create these scripts or mark them as "example only".

### 4.2 Cross-Platform Compatibility

The `anthropic-oracle.sh` uses:
- `declare -A` (requires bash 4+, macOS ships with 3.2)
- `stat -c %Y` (Linux) vs `stat -f %m` (macOS)

**Recommendation**: Test on macOS and add compatibility shims or document requirements.

### 4.3 Dependency Documentation

Scripts assume availability of:
- `jq` (JSON processing)
- `curl` (HTTP fetches)

**Recommendation**: Add dependency check at script start or document in CLAUDE.md.

### 4.4 Integration with Existing Systems

No updates to:
- CLAUDE.md (should document oracle workflow)
- `.claude/protocols/` index (should list new protocols)
- `discovering-requirements` skill (should reference EARS template)

**Recommendation**: Update integration points.

---

## 5. Success Criteria

PR #28 should be considered ready to merge when:

1. **Completeness**: All referenced scripts exist or are clearly marked as examples
2. **Correctness**: Cross-platform compatibility verified
3. **Consistency**: CLAUDE.md and skill integrations updated
4. **Documentation**: Dependencies documented
5. **Testing**: Oracle script commands manually verified

---

## 6. Recommended Actions

### Priority 1 (Blocking)

| Action | File | Reason |
|--------|------|--------|
| Add bash version check | `anthropic-oracle.sh` | macOS compatibility |
| Add jq dependency check | `anthropic-oracle.sh` | Runtime error prevention |
| Mark example scripts | `recommended-hooks.md` | Clarity on what exists |

### Priority 2 (Should Do)

| Action | File | Reason |
|--------|------|--------|
| Update CLAUDE.md | `CLAUDE.md` | Document oracle workflow |
| Reference EARS template | `discovering-requirements/SKILL.md` | Discoverability |
| Add `/oracle` command | `.claude/commands/` | Simpler invocation than script |

### Priority 3 (Nice to Have)

| Action | File | Reason |
|--------|------|--------|
| Create example hook scripts | `.claude/scripts/` | Working examples |
| Add content diffing | `anthropic-oracle.sh` | Change detection |
| Add duplicate issue detection | `oracle.yml` | Reduce noise |

---

## 7. Review Process

1. **Phase 1**: Technical correctness review (scripts, syntax)
2. **Phase 2**: Integration review (CLAUDE.md, skill references)
3. **Phase 3**: Gap closure (implement Priority 1 actions)
4. **Phase 4**: Final approval

---

## 8. Next Steps

When this PRD is approved:
1. Run `/review-sprint` style review on PR #28
2. Implement Priority 1 fixes
3. Request `/audit-sprint` for security review
4. Merge when approved

---

**Document Version**: 1.0
**Created**: 2026-01-12
**Status**: DRAFT - Awaiting Review
