# RLM Rule Index
# Maps detection patterns to rule files for on-demand loading
# Reduces /craft context from ~10k tokens to ~2k tokens

version: "1.0"

# Core summary always loaded (~1k tokens)
core_summary:
  file: "rlm-core-summary.md"
  tokens: 1000
  always_load: true

# Rules loaded based on pattern detection
rules:
  # ===========================================
  # PRIORITY 1: Core Physics (always checked)
  # ===========================================

  # Behavioral Physics
  - file: "01-sigil-physics.md"
    triggers:
      keywords:
        - "sync"
        - "timing"
        - "confirmation"
        - "optimistic"
        - "pessimistic"
        - "loading"
      effects:
        - "Financial"
        - "Destructive"
        - "Standard"
        - "Local"
    tokens: 750
    priority: 1

  # Effect Detection
  - file: "02-sigil-detection.md"
    triggers:
      keywords:
        - "claim"
        - "deposit"
        - "withdraw"
        - "delete"
        - "remove"
        - "like"
        - "follow"
        - "toggle"
        - "save"
        - "update"
      types:
        - "Currency"
        - "Money"
        - "Balance"
        - "Wei"
        - "Token"
        - "BigInt"
    tokens: 950
    priority: 1

  # Protected Capabilities (NON-NEGOTIABLE)
  - file: "04-sigil-protected.md"
    triggers:
      effects:
        - "Financial"
        - "Destructive"
      keywords:
        - "withdraw"
        - "cancel"
        - "balance"
        - "escape"
        - "back"
    tokens: 800
    priority: 1
    always_check: true

  # Data Physics (NEW - Web3)
  # NOTE: Requires web3-specific signals to avoid false positives
  # Generic signals like "??" or "useQuery" removed - too broad
  - file: "19-sigil-data-physics.md"
    triggers:
      keywords:
        - "envio"
        - "indexed"
        - "on-chain"
        - "web3"
        - "stale data"
        - "indexer"
      hooks:
        - "useReadContract"
        - "useWriteContract"
        - "useContractRead"
        - "useWaitForTransactionReceipt"
      # Require at least one web3-specific hook OR keyword
      # useQuery alone is not sufficient (generic React Query)
    tokens: 800
    priority: 1

  # Web3 Flow Patterns (NEW)
  - file: "20-sigil-web3-flows.md"
    triggers:
      keywords:
        - "stake"
        - "claim"
        - "withdraw"
        - "bridge"
        - "swap"
        - "approve"
        - "mint"
        - "burn"
        - "deposit"
        - "redeem"
      hooks:
        - "useWriteContract"
        - "usePrepareContractWrite"
        - "useContractWrite"
        - "useWaitForTransaction"
        - "useWaitForTransactionReceipt"
        - "useSendTransaction"
    tokens: 1200
    priority: 1

  # ===========================================
  # PRIORITY 2: Implementation Patterns
  # ===========================================

  # Golden Patterns
  - file: "03-sigil-patterns.md"
    triggers:
      keywords:
        - "button"
        - "modal"
        - "form"
        - "component"
        - "dialog"
        - "toast"
      craft_type:
        - "generate"
        - "refine"
    tokens: 1650
    priority: 2

  # Animation Physics
  - file: "05-sigil-animation.md"
    triggers:
      keywords:
        - "animation"
        - "transition"
        - "motion"
        - "spring"
        - "easing"
        - "bounce"
        - "fade"
      commands:
        - "/animate"
    tokens: 1500
    priority: 2

  # Material Physics
  - file: "07-sigil-material.md"
    triggers:
      keywords:
        - "style"
        - "surface"
        - "shadow"
        - "glass"
        - "material"
        - "gradient"
        - "border"
        - "radius"
      commands:
        - "/style"
    tokens: 1800
    priority: 2

  # Taste Accumulation
  - file: "06-sigil-taste.md"
    triggers:
      keywords:
        - "taste"
        - "preference"
        - "learn"
        - "modify"
        - "accept"
        - "reject"
    tokens: 1850
    priority: 2

  # Lexicon (Effect Keywords)
  - file: "08-sigil-lexicon.md"
    triggers:
      keywords:
        - "keyword"
        - "domain"
        - "context"
        - "e-commerce"
        - "social"
        - "admin"
    tokens: 1600
    priority: 2

  # UI Copy Physics
  - file: "21-sigil-ui-copy.md"
    triggers:
      keywords:
        - "copy"
        - "label"
        - "text"
        - "wording"
        - "terminology"
        - "rebate"
        - "fee"
        - "rewards"
        - "percentage"
      craft_type:
        - "generate"
        - "refine"
    tokens: 1800
    priority: 2

  # ===========================================
  # PRIORITY 3: React Rules (conditional)
  # ===========================================

  # React Core Index
  - file: "10-react-core.md"
    triggers:
      project_has:
        - "react"
        - "next"
      patterns:
        - "useState"
        - "useEffect"
        - "useMemo"
        - "useCallback"
    tokens: 1700
    priority: 3
    conditional: true

  # Async Patterns
  - file: "11-react-async.md"
    triggers:
      keywords:
        - "waterfall"
        - "Promise.all"
        - "Suspense"
        - "parallel"
      patterns:
        - "async"
        - "await"
        - "fetch"
    tokens: 1150
    priority: 3
    conditional: true

  # Bundle Optimization
  - file: "12-react-bundle.md"
    triggers:
      keywords:
        - "bundle"
        - "import"
        - "dynamic"
        - "lazy"
        - "tree-shaking"
    tokens: 1230
    priority: 3
    conditional: true

  # Rendering Optimization
  - file: "13-react-rendering.md"
    triggers:
      keywords:
        - "render"
        - "hydration"
        - "SVG"
        - "content-visibility"
    tokens: 1340
    priority: 3
    conditional: true

  # Re-render Prevention
  - file: "14-react-rerender.md"
    triggers:
      keywords:
        - "re-render"
        - "memo"
        - "transition"
        - "derived"
      patterns:
        - "useMemo"
        - "useCallback"
        - "React.memo"
    tokens: 1460
    priority: 3
    conditional: true

  # Server/Client Patterns
  - file: "15-react-server.md"
    triggers:
      keywords:
        - "server"
        - "client"
        - "RSC"
        - "SSR"
        - "cache"
        - "SWR"
    tokens: 1400
    priority: 3
    conditional: true

  # JS Micro-optimizations
  - file: "16-react-js.md"
    triggers:
      keywords:
        - "optimize"
        - "performance"
        - "loop"
        - "Map"
        - "Set"
    tokens: 2670
    priority: 3
    conditional: true

  # ===========================================
  # PRIORITY 4: Specialized
  # ===========================================

  # Complexity Detection (large file, load sparingly)
  - file: "18-sigil-complexity.md"
    triggers:
      keywords:
        - "indexer"
        - "envio"
        - "multi-repo"
        - "complexity"
        - "handoff"
      hooks:
        - "@envio-dev/indexer"
    tokens: 6800
    priority: 4
    conditional: true

  # Anchor/Lens Integration (Formal Verification)
  - file: "22-sigil-anchor-lens.md"
    triggers:
      keywords:
        - "validate"
        - "verify"
        - "constraint"
        - "anchor"
        - "lens"
        - "correction"
        - "violation"
      effects:
        - "Financial"
        - "Destructive"
        - "SoftDelete"
      zones:
        - "Critical"
        - "Cautious"
    tokens: 2200
    priority: 4
    # Load after physics analysis is confirmed, before code generation
    phase: "post_analysis"

  # Semantic Search
  - file: "17-semantic-search.md"
    triggers:
      keywords:
        - "ck"
        - "semantic"
        - "search"
    tokens: 185
    priority: 4

# Loading strategy
loading:
  # Maximum tokens to load per invocation (soft limit)
  max_tokens: 4000

  # Priority order for loading (lower = higher priority)
  priority_order: [1, 2, 3, 4, 5, 6]

  # Stop loading lower priority rules when limit reached
  stop_on_limit: true

  # Always include these regardless of limit (protected capabilities)
  required:
    - "04-sigil-protected.md"

  # Skip these rules on iteration 2+ if already applied
  skip_on_continuation:
    - "03-sigil-patterns.md"
    - "01-sigil-physics.md"
    - "05-sigil-animation.md"
    - "07-sigil-material.md"

# ===========================================
# PRIORITY 5: Project Extensions
# ===========================================
# Project-specific rules that extend or customize Sigil physics
# These are loaded from grimoires/sigil/rules/ in the target project

extensions:
  # Path where projects can add custom rules
  paths:
    - "grimoires/sigil/rules/*.md"

  # Extension rules are loaded after core rules
  priority: 5

  # Extensions can override core physics (use with caution)
  allow_override: true

  # Schema for extension files
  schema:
    required_fields:
      - "name"           # Rule name for identification
      - "triggers"       # When to load this extension
    optional_fields:
      - "tokens"         # Estimated token count
      - "overrides"      # Which core rules this modifies
      - "description"    # Human-readable description

# ===========================================
# PRIORITY 6: Local Overrides
# ===========================================
# Developer-specific overrides (not committed to repo)
# These take highest priority for local customization

overrides:
  # Path for local override files
  paths:
    - ".claude/overrides/*.md"

  # Overrides have highest priority
  priority: 6

  # Overrides always win over extensions and core
  allow_override: true

  # Typical override use cases:
  # - Faster timings for power users
  # - Custom taste preferences
  # - Project-specific physics adjustments

  # Example override file format:
  # ```markdown
  # # Override: 01-sigil-physics
  #
  # ## Custom Timings
  #
  # For this project, use faster timings:
  #
  # | Effect | Default | Override |
  # |--------|---------|----------|
  # | Financial | 800ms | 500ms |
  # | Destructive | 600ms | 400ms |
  #
  # ## Rationale
  # Power user audience prefers snappier interactions.
  # ```

# Extension discovery algorithm
extension_loading:
  # 1. Scan extension paths for .md files
  # 2. Parse YAML frontmatter for triggers
  # 3. Match triggers against current context
  # 4. Load matching extensions after core rules
  # 5. Apply overrides last (highest priority)

  # Frontmatter schema for extension files:
  # ```yaml
  # ---
  # name: "custom-timing"
  # triggers:
  #   keywords: ["fast", "snappy"]
  #   effects: ["Financial"]
  # tokens: 200
  # overrides: ["01-sigil-physics.md"]
  # ---
  # ```

  # Discovery is cached per session
  cache_duration: "session"

# ===========================================
# SEARCH CONFIGURATION
# ===========================================
# Unified search abstraction for /craft and other skills

search:
  # Detection script for ck availability
  detection_script: ".claude/scripts/sigil-search.sh"

  # Environment variable set after detection
  env_var: "SIGIL_SEARCH_MODE"

  # Supported modes (in priority order)
  modes:
    - name: "ck"
      binary: "ck"
      capabilities: ["semantic", "hybrid", "regex"]
      preferred: true
    - name: "grep"
      binary: "grep"
      capabilities: ["regex"]
      fallback: true

  # Output format (consistent across all modes)
  output_format: "jsonl"
  output_schema:
    file: "string"      # Absolute file path
    line: "number"      # Line number
    snippet: "string"   # Matched content
    score: "number"     # Relevance score (0.0 for grep)

  # User-facing behavior
  transparent: true     # Never mention tool choice to user
  cache_detection: true # Cache detection result per session
