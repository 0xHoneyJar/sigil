# Sigil CI Workflow v1.2.4
# Validates recipe compliance and physics rules

name: Sigil

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main]

jobs:
  validate:
    name: Validate Sigil Rules
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Run ESLint with Sigil rules
        run: |
          npx eslint . \
            --ext .ts,.tsx \
            --config eslint.config.js \
            --format stylish
        continue-on-error: false

      - name: Check for IMPOSSIBLE violations
        run: |
          # Check for optimistic UI in decisive zones
          echo "Checking for IMPOSSIBLE violations..."

          # Search for patterns that would be IMPOSSIBLE violations
          VIOLATIONS=$(grep -r "set[A-Z].*await" src/checkout src/transaction src/payment 2>/dev/null || true)

          if [ -n "$VIOLATIONS" ]; then
            echo "::error::IMPOSSIBLE violation: Optimistic UI pattern detected in decisive zone"
            echo "$VIOLATIONS"
            exit 1
          fi

          echo "No IMPOSSIBLE violations found"

      - name: Validate sandbox age
        run: |
          echo "Checking for stale sandboxes..."

          # Find sandbox files older than 7 days
          STALE_SANDBOXES=$(find . -name "*.tsx" -mtime +7 -exec grep -l "// sigil-sandbox" {} \; 2>/dev/null || true)

          if [ -n "$STALE_SANDBOXES" ]; then
            echo "::warning::Stale sandboxes detected (>7 days old):"
            echo "$STALE_SANDBOXES"
            echo "Consider running /codify to extract physics to recipes"
          fi

      - name: Recipe coverage report
        run: |
          echo "Generating recipe coverage report..."

          # Count files with recipe imports
          RECIPE_FILES=$(grep -rl "@sigil/recipes" src/ 2>/dev/null | wc -l || echo "0")

          # Count files with animation libraries
          ANIMATED_FILES=$(grep -rl "framer-motion\|react-spring" src/ 2>/dev/null | wc -l || echo "0")

          if [ "$ANIMATED_FILES" -gt 0 ]; then
            COVERAGE=$((RECIPE_FILES * 100 / ANIMATED_FILES))
            echo "Recipe Coverage: ${COVERAGE}% (${RECIPE_FILES}/${ANIMATED_FILES} animated files)"

            if [ "$COVERAGE" -lt 80 ]; then
              echo "::warning::Recipe coverage is below 80%. Run /garden for details."
            fi
          else
            echo "No animated files found"
          fi

  notify:
    name: Notify on failure
    runs-on: ubuntu-latest
    needs: validate
    if: failure()

    steps:
      - name: Post failure comment
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: `## âŒ Sigil Validation Failed

            Physics violations detected. Please review:

            1. **Raw physics**: Use recipes from \`@sigil/recipes/\` instead of raw spring values
            2. **Missing recipes**: Import recipes for animated components
            3. **Optimistic UI**: Use \`useServerTick\` in decisive zones
            4. **Stale sandboxes**: Run \`/codify\` on sandboxes >7 days old

            Run \`/validate\` locally to see detailed violations.`
            })
