name: Melange Discord Notification

on:
  issues:
    types: [opened]

jobs:
  notify:
    runs-on: ubuntu-latest
    if: contains(github.event.issue.labels.*.name, 'melange')

    steps:
      - name: Parse Melange Issue
        id: parse
        uses: actions/github-script@v7
        with:
          script: |
            const issue = context.payload.issue;
            const labels = issue.labels.map(l => l.name);
            const body = issue.body || '';

            // Extract routing from labels or body
            let toConstruct = 'unknown';
            const toLabel = labels.find(l => l.startsWith('to:'));
            if (toLabel) {
              toConstruct = toLabel.replace('to:', '');
            } else {
              const toMatch = body.match(/### To \(Receiving Construct\)\s*\n\n(\w+)/i);
              if (toMatch) {
                toConstruct = toMatch[1].toLowerCase();
              }
            }

            // Extract impact from labels or body
            let impact = 'unknown';
            const impactLabel = labels.find(l => l.startsWith('impact:'));
            if (impactLabel) {
              impact = impactLabel.replace('impact:', '');
            } else {
              const impactMatch = body.match(/### Impact\s*\n\n([\w-]+)/i);
              if (impactMatch) {
                impact = impactMatch[1].toLowerCase();
              }
            }

            // Extract intent from labels or body
            let intent = 'request';
            const intentLabel = labels.find(l => l.startsWith('intent:'));
            if (intentLabel) {
              intent = intentLabel.replace('intent:', '');
            } else {
              const intentMatch = body.match(/### Intent\s*\n\n(\w+)/i);
              if (intentMatch) {
                intent = intentMatch[1].toLowerCase();
              }
            }

            // Extract from operator
            let fromOperator = context.repo.repo;
            const fromMatch = body.match(/### From \(Your Construct \+ Operator\)\s*\n\n(.+)/i);
            if (fromMatch) {
              fromOperator = fromMatch[1].trim();
            }

            // Extract experience summary (first 200 chars)
            let experience = '';
            const expMatch = body.match(/### What are you experiencing\?\s*\n\n([\s\S]*?)(?=\n###|$)/i);
            if (expMatch) {
              experience = expMatch[1].trim().substring(0, 200);
              if (expMatch[1].trim().length > 200) experience += '...';
            }

            // Extract request
            let request = '';
            const reqMatch = body.match(/### What would help\?\s*\n\n([\s\S]*?)(?=\n###|$)/i);
            if (reqMatch) {
              request = reqMatch[1].trim().substring(0, 150);
              if (reqMatch[1].trim().length > 150) request += '...';
            }

            const fromRepo = context.repo.repo;

            core.setOutput('to', toConstruct);
            core.setOutput('from_repo', fromRepo);
            core.setOutput('from_operator', fromOperator);
            core.setOutput('impact', impact);
            core.setOutput('intent', intent);
            core.setOutput('title', issue.title.replace('[Melange] ', ''));
            core.setOutput('url', issue.html_url);
            core.setOutput('number', issue.number);
            core.setOutput('experience', experience);
            core.setOutput('request', request);

      - name: Auto-apply routing label
        if: "!contains(github.event.issue.labels.*.name, 'to:')"
        uses: actions/github-script@v7
        with:
          script: |
            const body = context.payload.issue.body || '';
            const toMatch = body.match(/### To \(Receiving Construct\)\s*\n\n(\w+)/i);

            if (toMatch) {
              const toConstruct = toMatch[1].toLowerCase();
              const validConstructs = ['sigil', 'loa', 'registry', 'loa-constructs'];

              if (validConstructs.includes(toConstruct)) {
                await github.rest.issues.addLabels({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  issue_number: context.payload.issue.number,
                  labels: [`to:${toConstruct}`]
                });
              }
            }

      - name: Auto-apply impact label
        if: "!contains(github.event.issue.labels.*.name, 'impact:')"
        uses: actions/github-script@v7
        with:
          script: |
            const body = context.payload.issue.body || '';
            const impactMatch = body.match(/### Impact\s*\n\n([\w-]+)/i);

            if (impactMatch) {
              const impact = impactMatch[1].toLowerCase();
              const validImpacts = ['game-changing', 'important', 'nice-to-have'];

              if (validImpacts.includes(impact)) {
                await github.rest.issues.addLabels({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  issue_number: context.payload.issue.number,
                  labels: [`impact:${impact}`]
                });
              }
            }

      - name: Send Discord Embed (game-changing)
        if: steps.parse.outputs.impact == 'game-changing'
        env:
          DISCORD_WEBHOOK: ${{ secrets.MELANGE_DISCORD_WEBHOOK }}
        run: |
          if [ -n "$DISCORD_WEBHOOK" ]; then
            curl -H "Content-Type: application/json" \
              -d '{
                "content": "@here",
                "embeds": [{
                  "title": "ðŸ”´ ${{ steps.parse.outputs.title }}",
                  "url": "${{ steps.parse.outputs.url }}",
                  "color": 15158332,
                  "fields": [
                    {
                      "name": "From",
                      "value": "${{ steps.parse.outputs.from_operator }}",
                      "inline": true
                    },
                    {
                      "name": "To",
                      "value": "${{ steps.parse.outputs.to }}",
                      "inline": true
                    },
                    {
                      "name": "Intent",
                      "value": "${{ steps.parse.outputs.intent }}",
                      "inline": true
                    },
                    {
                      "name": "Experience",
                      "value": "${{ steps.parse.outputs.experience }}"
                    },
                    {
                      "name": "Request",
                      "value": "${{ steps.parse.outputs.request }}"
                    }
                  ],
                  "footer": {
                    "text": "Melange Protocol â€¢ ${{ steps.parse.outputs.from_repo }}#${{ steps.parse.outputs.number }}"
                  },
                  "timestamp": "${{ github.event.issue.created_at }}"
                }]
              }' \
              "$DISCORD_WEBHOOK"
          fi

      - name: Send Discord Embed (important)
        if: steps.parse.outputs.impact == 'important'
        env:
          DISCORD_WEBHOOK: ${{ secrets.MELANGE_DISCORD_WEBHOOK }}
        run: |
          if [ -n "$DISCORD_WEBHOOK" ]; then
            curl -H "Content-Type: application/json" \
              -d '{
                "embeds": [{
                  "title": "ðŸŸ¡ ${{ steps.parse.outputs.title }}",
                  "url": "${{ steps.parse.outputs.url }}",
                  "color": 16776960,
                  "fields": [
                    {
                      "name": "From",
                      "value": "${{ steps.parse.outputs.from_operator }}",
                      "inline": true
                    },
                    {
                      "name": "To",
                      "value": "${{ steps.parse.outputs.to }}",
                      "inline": true
                    },
                    {
                      "name": "Intent",
                      "value": "${{ steps.parse.outputs.intent }}",
                      "inline": true
                    },
                    {
                      "name": "Experience",
                      "value": "${{ steps.parse.outputs.experience }}"
                    },
                    {
                      "name": "Request",
                      "value": "${{ steps.parse.outputs.request }}"
                    }
                  ],
                  "footer": {
                    "text": "Melange Protocol â€¢ ${{ steps.parse.outputs.from_repo }}#${{ steps.parse.outputs.number }}"
                  },
                  "timestamp": "${{ github.event.issue.created_at }}"
                }]
              }' \
              "$DISCORD_WEBHOOK"
          fi

      # nice-to-have: no notification (discoverable via GitHub search)
