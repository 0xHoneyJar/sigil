name: Sigil Survival Engine

on:
  push:
    branches: [main]
    paths:
      - 'src/components/**/*.tsx'
      - 'src/components/**/*.ts'

jobs:
  survival-scan:
    name: Run Survival Engine
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Run Survival Engine
        run: |
          npx ts-node -e "
            const { runSurvivalEngine, generateReport, saveStats } = require('./sigil-mark/process/survival-engine');

            async function main() {
              console.log('üîç Running Sigil Survival Engine...');

              const result = await runSurvivalEngine(process.cwd(), 'push');

              console.log('üìä Scan Results:');
              console.log(\`  Components scanned: \${result.scanned}\`);
              console.log(\`  Eligible for promotion: \${result.eligible}\`);
              console.log(\`  Promotions queued: \${result.promotions.length}\`);
              console.log(\`  Demotions executed: \${result.demoted}\`);

              if (result.promotions.length > 0) {
                console.log('\\nüöÄ Pending Promotions (24h veto window):');
                for (const p of result.promotions) {
                  console.log(\`  ‚Ä¢ \${p.componentName}: \${p.fromTier} ‚Üí \${p.toTier}\`);
                }
              }

              if (result.demotions.length > 0) {
                console.log('\\n‚¨áÔ∏è Demotions Executed:');
                for (const d of result.demotions) {
                  console.log(\`  ‚Ä¢ \${d.componentName}: \${d.fromTier} ‚Üí \${d.toTier} (\${d.reason})\`);
                }
              }
            }

            main().catch(console.error);
          "

      - name: Commit survival stats
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "Sigil Survival Engine"

          if git diff --quiet .sigil/survival-stats.json; then
            echo "No changes to survival stats"
          else
            git add .sigil/survival-stats.json
            git commit -m "chore(sigil): update survival stats [skip ci]"
            git push
          fi
